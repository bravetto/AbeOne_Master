name: lint-and-format-check

on:
  pull_request:
    branches: [dev, main]
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  checks: write
  pull-requests: read

jobs:
  check:
    runs-on: [arc-runner-set]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install linting tools
        run: |
          pip install ruff black isort mypy

      - name: Run Black format check
        id: black_check
        run: |
          echo "ðŸŽ¨ Checking code formatting with Black..."
          set +e

          black --check --diff . > black-report.txt 2>&1
          BLACK_EXIT_CODE=$?

          BLACK_COUNT=$(grep -c "would reformat" black-report.txt 2>/dev/null || true)
          if [ -z "$BLACK_COUNT" ]; then
            BLACK_COUNT=0
          fi
          echo "black_count=$BLACK_COUNT" >> $GITHUB_OUTPUT
          echo "DEBUG: Black exit code: $BLACK_EXIT_CODE, file count: $BLACK_COUNT"

          echo "::group::ðŸŽ¨ Black Formatting Results"
          if [ "$BLACK_COUNT" -gt 0 ]; then
            echo "::warning::Found $BLACK_COUNT file(s) needing formatting"
            cat black-report.txt
          else
            echo "âœ… All files properly formatted"
          fi
          echo "::endgroup::"

      - name: Run isort import sorting check
        id: isort_check
        run: |
          echo "ðŸ“¦ Checking import sorting with isort..."
          set +e

          isort --check-only --diff . > isort-report.txt 2>&1
          ISORT_EXIT_CODE=$?

          # Count files that would be reformatted
          ISORT_COUNT=$(grep -c "would reformat" isort-report.txt 2>/dev/null || true)
          if [ -z "$ISORT_COUNT" ]; then
            ISORT_COUNT=0
          fi
          
          # If exit code is non-zero but count is 0, there are still issues
          if [ "$ISORT_EXIT_CODE" -ne 0 ] && [ "$ISORT_COUNT" -eq 0 ]; then
            ISORT_COUNT=1
          fi
          
          echo "isort_count=$ISORT_COUNT" >> $GITHUB_OUTPUT
          echo "DEBUG: isort exit code: $ISORT_EXIT_CODE, issue count: $ISORT_COUNT"

          echo "::group::ðŸ“¦ isort Import Sorting Results"
          if [ "$ISORT_COUNT" -gt 0 ]; then
            echo "::warning::Found import sorting issues in $ISORT_COUNT file(s)"
            cat isort-report.txt
          else
            echo "âœ… All imports properly sorted"
          fi
          echo "::endgroup::"

      - name: Run Ruff linting
        id: ruff_check
        run: |
          echo "âš¡ Running Ruff linter..."
          set +e

          ruff check . --output-format=json > ruff-report.json 2>&1
          RUFF_EXIT_CODE=$?
          ruff check . > ruff-report.txt 2>&1

          RUFF_COUNT=$(jq 'length' ruff-report.json 2>/dev/null || echo "0")
          echo "ruff_count=$RUFF_COUNT" >> $GITHUB_OUTPUT
          echo "DEBUG: Ruff exit code: $RUFF_EXIT_CODE, issue count: $RUFF_COUNT"

          echo "::group::âš¡ Ruff Linting Results"
          if [ "$RUFF_COUNT" -gt 0 ]; then
            echo "::warning::Found $RUFF_COUNT linting issue(s)"
            cat ruff-report.txt
          else
            echo "âœ… No linting issues found"
          fi
          echo "::endgroup::"

      - name: Run MyPy type checking
        id: mypy_check
        run: |
          echo "ðŸ” Running MyPy type checking..."
          set +e

          mypy . --ignore-missing-imports > mypy-report.txt 2>&1
          MYPY_EXIT_CODE=$?

          MYPY_COUNT=$(grep -c "error:" mypy-report.txt 2>/dev/null || true)
          if [ -z "$MYPY_COUNT" ]; then
            MYPY_COUNT=0
          fi
          echo "mypy_count=$MYPY_COUNT" >> $GITHUB_OUTPUT
          echo "DEBUG: MyPy exit code: $MYPY_EXIT_CODE, error count: $MYPY_COUNT"

          echo "::group::ðŸ” MyPy Type Checking Results"
          if [ "$MYPY_COUNT" -gt 0 ]; then
            echo "::warning::Found $MYPY_COUNT type error(s)"
            cat mypy-report.txt
          else
            echo "âœ… No type errors found"
          fi
          echo "::endgroup::"

      - name: Create Lint Summary
        id: create_summary
        if: always()
        run: |
          BLACK_COUNT="${{ steps.black_check.outputs.black_count }}"
          ISORT_COUNT="${{ steps.isort_check.outputs.isort_count }}"
          RUFF_COUNT="${{ steps.ruff_check.outputs.ruff_count }}"
          MYPY_COUNT="${{ steps.mypy_check.outputs.mypy_count }}"
          TOTAL=$((BLACK_COUNT + ISORT_COUNT + RUFF_COUNT + MYPY_COUNT))

          echo "total_issues=$TOTAL" >> $GITHUB_OUTPUT

          echo "## ðŸ” Lint & Format Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Tool | Issues Found |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------------|" >> $GITHUB_STEP_SUMMARY
          echo "| Black | $BLACK_COUNT files |" >> $GITHUB_STEP_SUMMARY
          echo "| isort | $ISORT_COUNT issues |" >> $GITHUB_STEP_SUMMARY
          echo "| Ruff | $RUFF_COUNT issues |" >> $GITHUB_STEP_SUMMARY
          echo "| MyPy | $MYPY_COUNT errors |" >> $GITHUB_STEP_SUMMARY
          echo "| **Total** | **$TOTAL** |" >> $GITHUB_STEP_SUMMARY

          if [ $TOTAL -gt 0 ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ **Code quality issues detected. Review the job logs for details.**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Quick Fix Commands:" >> $GITHUB_STEP_SUMMARY
            echo '```bash' >> $GITHUB_STEP_SUMMARY
            echo "black ." >> $GITHUB_STEP_SUMMARY
            echo "isort ." >> $GITHUB_STEP_SUMMARY
            echo "ruff check . --fix" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

      - name: Create custom check with warning indicator
        if: always()
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const blackCount = parseInt('${{ steps.black_check.outputs.black_count }}') || 0;
            const isortCount = parseInt('${{ steps.isort_check.outputs.isort_count }}') || 0;
            const ruffCount = parseInt('${{ steps.ruff_check.outputs.ruff_count }}') || 0;
            const mypyCount = parseInt('${{ steps.mypy_check.outputs.mypy_count }}') || 0;
            const totalIssues = blackCount + isortCount + ruffCount + mypyCount;
            const isMainBranch = context.payload.pull_request?.base?.ref === 'main';
            
            // SAFETY: GitHub API limit is 65535 characters for check run output.text
            // VERIFY: Truncation accounts for truncation message length
            // FAILS: If truncation logic doesn't properly account for buffer
            
            const MAX_TEXT_LENGTH = 65535;
            const TRUNCATE_MESSAGE = '\n\n...(truncated due to size limit)';
            const TRUNCATE_BUFFER = TRUNCATE_MESSAGE.length;
            const MAX_SECTION_LENGTH = 15000; // Per-section limit to prevent overflow
            
            // Helper function to safely truncate text
            function safeTruncate(text, maxLength) {
              if (text.length <= maxLength) return text;
              // Truncate leaving room for truncation message
              return text.substring(0, maxLength - TRUNCATE_BUFFER) + TRUNCATE_MESSAGE;
            }
            
            // Read the detailed reports with per-section truncation
            const fs = require('fs');
            let detailedText = '';
            
            try {
              if (fs.existsSync('black-report.txt') && blackCount > 0) {
                let blackReport = fs.readFileSync('black-report.txt', 'utf8');
                blackReport = safeTruncate(blackReport, MAX_SECTION_LENGTH);
                detailedText += '## Black Formatting Issues\n\n```\n' + blackReport + '\n```\n\n';
              }
              
              if (fs.existsSync('isort-report.txt') && isortCount > 0) {
                let isortReport = fs.readFileSync('isort-report.txt', 'utf8');
                isortReport = safeTruncate(isortReport, MAX_SECTION_LENGTH);
                detailedText += '## isort Import Issues\n\n```\n' + isortReport + '\n```\n\n';
              }
              
              if (fs.existsSync('ruff-report.txt') && ruffCount > 0) {
                let ruffReport = fs.readFileSync('ruff-report.txt', 'utf8');
                ruffReport = safeTruncate(ruffReport, MAX_SECTION_LENGTH);
                detailedText += '## Ruff Linting Issues\n\n```\n' + ruffReport + '\n```\n\n';
              }
              
              if (fs.existsSync('mypy-report.txt') && mypyCount > 0) {
                let mypyReport = fs.readFileSync('mypy-report.txt', 'utf8');
                mypyReport = safeTruncate(mypyReport, MAX_SECTION_LENGTH);
                detailedText += '## MyPy Type Errors\n\n```\n' + mypyReport + '\n```\n\n';
              }
            } catch (error) {
              console.log('Could not read report files:', error);
            }
            
            // Final safety truncation to ensure we never exceed limit
            detailedText = safeTruncate(detailedText, MAX_TEXT_LENGTH);
            
            let conclusion, title, summary;
            
            if (totalIssues === 0) {
              conclusion = 'success';
              title = 'âœ… All code quality checks passed';
              summary = '**No linting or formatting issues found.**\n\nYour code meets all quality standards.';
            } else if (isMainBranch) {
              conclusion = 'success';
              title = `âŒ Found ${totalIssues} code quality issues`;
              summary = `**âš ï¸ Code quality issues found for main branch:** ${totalIssues}\n- Black: ${blackCount}\n- isort: ${isortCount}\n- Ruff: ${ruffCount}\n- MyPy: ${mypyCount}\n\nâŒ These should be addressed before merging.\n\nðŸ“‹ Click "Details" below to see the full report with all issues.`;
            } else {
              conclusion = 'success';
              title = `âš ï¸ Found ${totalIssues} code quality issues (warnings)`;
              summary = `**Code quality issues found:** ${totalIssues}\n- Black: ${blackCount}\n- isort: ${isortCount}\n- Ruff: ${ruffCount}\n- MyPy: ${mypyCount}\n\nâš ï¸ These are warnings only for dev branch. Review and fix before merging to main.\n\nðŸ“‹ Click "Details" below to see the full report with all issues.`;
            }
            
            // VERIFY: Final text length is within limit
            if (detailedText.length > MAX_TEXT_LENGTH) {
              console.log(`WARNING: Text still exceeds limit after truncation: ${detailedText.length} > ${MAX_TEXT_LENGTH}`);
              // Force truncation as last resort
              detailedText = detailedText.substring(0, MAX_TEXT_LENGTH - TRUNCATE_BUFFER) + TRUNCATE_MESSAGE;
            }
            
            await github.rest.checks.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: 'lint-and-format-check',
              head_sha: context.payload.pull_request.head.sha,
              status: 'completed',
              conclusion: conclusion,
              output: {
                title: title,
                summary: summary,
                text: detailedText
              }
            });


name: Docker Build and ECR Push - Backend
on:
  workflow_dispatch:
  pull_request:
    branches: [dev, main]
    types: [closed]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  AWS_REGION: us-east-1
  APP_NAME: emergent-os-server
  ECR_REGISTRY: 730335329303.dkr.ecr.us-east-1.amazonaws.com
  ECR_REPOSITORY: emergent-os-server

jobs:
  build_and_push:
    runs-on: [arc-runner-set]
    if: github.event_name == 'workflow_dispatch' || github.event.pull_request.merged == true

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx with Kubernetes driver
      uses: docker/setup-buildx-action@v3
      with:
        driver: kubernetes
        driver-opts: |
          namespace=buildkit
        install: false
        use: true
        keep-state: false
        cache-binary: true
        cleanup: true

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        # Uses IRSA (IAM Roles for Service Accounts) from your runner pod
        aws-region: ${{ env.AWS_REGION }}

    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2

    - name: Determine image tag
      id: tag
      run: |
        BRANCH_NAME=${GITHUB_REF#refs/heads/}
        COMMIT_SHA=${GITHUB_SHA:0:8}

        # Check if manually triggered
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          echo "ğŸ”§ Manual trigger detected"
        fi

        # Simple tagging strategy
        if [[ "$BRANCH_NAME" == "dev" ]]; then
          IMAGE_TAG="dev"
          echo "ğŸ”„ Dev branch â†’ using :dev tag"
        elif [[ "$BRANCH_NAME" == "main" ]]; then
          IMAGE_TAG="latest"
          echo "ğŸš€ Main branch â†’ using :latest tag"
        else
          IMAGE_TAG="$COMMIT_SHA"
          echo "ğŸŒ¿ Feature branch â†’ using :$COMMIT_SHA tag"
        fi

        echo "Branch: $BRANCH_NAME"
        echo "Selected tag: $IMAGE_TAG"
        echo "Trigger: ${{ github.event_name }}"

        # Export for next steps
        echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_OUTPUT
        echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_OUTPUT
        echo "COMMIT_SHA=$COMMIT_SHA" >> $GITHUB_OUTPUT

    - name: Build and Push Docker image
      run: |
        set -e  # Exit on any error

        IMAGE_TAG="${{ steps.tag.outputs.IMAGE_TAG }}"
        ECR_REGISTRY="${{ env.ECR_REGISTRY }}"
        ECR_REPOSITORY="${{ env.ECR_REPOSITORY }}"
        DOCKERFILE_PATH="EMERGENT_OS/server/Dockerfile"
        BUILD_CONTEXT="EMERGENT_OS/server"

        echo "ğŸ—ï¸  Building emergent-os-server for AMD-64 (AWS) with tag: $IMAGE_TAG"
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ“¦ Building: emergent-os-server"
        echo "ğŸ“ Context: $BUILD_CONTEXT"
        echo "ğŸ“„ Dockerfile: $DOCKERFILE_PATH"
        echo "ğŸ·ï¸  ECR Repo: $ECR_REPOSITORY"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

        if docker buildx build \
          --platform linux/amd64 \
          --no-cache \
          --push \
          -f "$DOCKERFILE_PATH" \
          -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG \
          $BUILD_CONTEXT; then
          echo "âœ… Successfully pushed: $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"
        else
          echo "âŒ Failed to build: emergent-os-server"
          exit 1
        fi

    - name: Trigger deployment workflow
      if: success() && steps.tag.outputs.BRANCH_NAME == 'dev'
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.CI_CD }}
        script: |
          const AWS_REGION = "${{ env.AWS_REGION }}";
          const ECR_REGISTRY = "${{ env.ECR_REGISTRY }}";
          const APP_NAME = "${{ env.APP_NAME }}";
          const ECR_REPOSITORY = "${{ env.ECR_REPOSITORY }}";
          const BRANCH_NAME = "${{ steps.tag.outputs.BRANCH_NAME }}";
          const IMAGE_TAG = "${{ steps.tag.outputs.IMAGE_TAG }}";
          const COMMIT_SHA = "${{ github.sha }}";

          await github.rest.actions.createWorkflowDispatch({
            owner: context.repo.owner,
            repo: context.repo.repo,
            workflow_id: 'deploy.yml',
            ref: BRANCH_NAME,
            inputs: {
              aws_region: AWS_REGION,
              app_name: APP_NAME,
              ecr_registry: ECR_REGISTRY,
              ecr_repository: ECR_REPOSITORY,
              branch: BRANCH_NAME,
              image_tag: IMAGE_TAG,
              commit_sha: COMMIT_SHA,
              build_run_id: "${{ github.run_id }}"
            }
          });
          
          console.log("âœ… Deployment workflow triggered successfully");

    - name: Output build summary
      run: |
        ECR_REGISTRY="${{ env.ECR_REGISTRY }}"
        ECR_REPOSITORY="${{ env.ECR_REPOSITORY }}"
        APP_NAME="${{ env.APP_NAME }}"
        IMAGE_TAG="${{ steps.tag.outputs.IMAGE_TAG }}"
        BRANCH_NAME="${{ steps.tag.outputs.BRANCH_NAME }}"
        COMMIT_SHA="${{ steps.tag.outputs.COMMIT_SHA }}"
        TRIGGER_TYPE="${{ github.event_name }}"

        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ‰ Build Complete - emergent-os-server Pushed to ECR"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        echo "ğŸ“¦ Registry: $ECR_REGISTRY"
        echo "ğŸ”– Tag: $IMAGE_TAG"
        echo "ğŸŒ¿ Branch: $BRANCH_NAME"
        echo "ğŸ“ Commit: $COMMIT_SHA"
        echo "âš¡ Trigger: $TRIGGER_TYPE"
        echo "ğŸ–¥ï¸  Platform: linux/amd64 (AWS compatible)"
        echo ""
        echo "ğŸš€ Image URL:"
        echo "   $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"
        echo ""


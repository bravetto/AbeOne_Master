<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üõ°Ô∏è Drift Protection Dashboard - Real-Time</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --bg-primary: #1e1e1e;
            --bg-secondary: #252526;
            --bg-tertiary: #2d2d30;
            --border-color: #3e3e42;
            --text-primary: #cccccc;
            --text-secondary: #858585;
            --accent-green: #4ec9b0;
            --accent-yellow: #f48771;
            --accent-blue: #569cd6;
            --accent-red: #f48771;
            --success-bg: #1e3a1e;
            --warning-bg: #3a2e1e;
            --info-bg: #1e1e3a;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 25px;
            background: var(--bg-secondary);
            border-radius: 12px;
            border: 2px solid var(--border-color);
            position: relative;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
            color: var(--accent-green);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--accent-green);
            animation: pulse 2s infinite;
            margin-left: 10px;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.1); }
        }
        
        .refresh-status {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 10px;
        }
        
        .last-updated {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 11px;
            color: var(--text-secondary);
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .card {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 20px;
            border: 2px solid var(--border-color);
            transition: all 0.3s ease;
        }
        
        .card:hover {
            border-color: var(--accent-green);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(78, 201, 176, 0.2);
        }
        
        .card-header {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: var(--accent-green);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .project-card {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid;
            transition: all 0.3s ease;
        }
        
        .project-card.active {
            border-left-color: var(--accent-green);
            background: var(--success-bg);
        }
        
        .project-card.legacy {
            border-left-color: var(--accent-yellow);
            background: var(--warning-bg);
        }
        
        .project-card.operational {
            border-left-color: var(--accent-blue);
        }
        
        .project-card.needs-fixes {
            border-left-color: var(--accent-red);
        }
        
        .project-name {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 8px;
            color: var(--text-primary);
        }
        
        .project-status {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 8px;
        }
        
        .project-status.active {
            background: var(--accent-green);
            color: var(--bg-primary);
        }
        
        .project-status.legacy {
            background: var(--accent-yellow);
            color: var(--bg-primary);
        }
        
        .project-status.operational {
            background: var(--accent-blue);
            color: var(--bg-primary);
        }
        
        .project-status.needs-fixes {
            background: var(--accent-red);
            color: var(--bg-primary);
        }
        
        .project-status.not-running {
            background: var(--accent-red);
            color: var(--bg-primary);
        }
        
        .project-info {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 8px;
        }
        
        .score-bar {
            margin-top: 10px;
            height: 6px;
            background: var(--bg-tertiary);
            border-radius: 3px;
            overflow: hidden;
        }
        
        .score-fill {
            height: 100%;
            transition: width 0.5s ease;
            border-radius: 3px;
        }
        
        .score-fill.high {
            background: var(--accent-green);
        }
        
        .score-fill.medium {
            background: var(--accent-yellow);
        }
        
        .score-fill.low {
            background: var(--accent-red);
        }
        
        .protection-layers {
            margin-top: 15px;
        }
        
        .layer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .layer:last-child {
            border-bottom: none;
        }
        
        .layer-name {
            font-size: 13px;
            color: var(--text-primary);
        }
        
        .layer-status {
            font-size: 11px;
            color: var(--accent-green);
        }
        
        .critical-actions {
            margin-top: 15px;
        }
        
        .action-item {
            padding: 10px;
            margin: 8px 0;
            background: var(--bg-tertiary);
            border-radius: 6px;
            border-left: 3px solid var(--accent-red);
        }
        
        .action-priority {
            font-size: 11px;
            font-weight: bold;
            color: var(--accent-red);
            margin-bottom: 4px;
        }
        
        .action-text {
            font-size: 13px;
            color: var(--text-primary);
            margin-bottom: 4px;
        }
        
        .action-command {
            font-size: 11px;
            color: var(--accent-blue);
            font-family: 'Courier New', monospace;
            background: var(--bg-primary);
            padding: 4px 8px;
            border-radius: 4px;
            margin-top: 4px;
            display: inline-block;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .metric {
            text-align: center;
            padding: 15px;
            background: var(--bg-tertiary);
            border-radius: 8px;
        }
        
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--accent-green);
            margin-bottom: 5px;
        }
        
        .metric-label {
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
        }
        
        .footer {
            text-align: center;
            margin-top: 30px;
            padding: 20px;
            color: var(--text-secondary);
            font-size: 12px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }
        
        .error {
            padding: 20px;
            background: var(--warning-bg);
            border-radius: 8px;
            border-left: 4px solid var(--accent-red);
            color: var(--text-primary);
        }
        
        .updating {
            opacity: 0.6;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>
                üõ°Ô∏è Drift Protection Dashboard
                <span class="status-indicator" id="status-indicator"></span>
            </h1>
            <div class="refresh-status" id="refresh-status">Loading...</div>
            <div class="last-updated" id="last-updated"></div>
        </div>
        
        <div id="dashboard-content" class="loading">
            <div>Loading dashboard data...</div>
        </div>
        
        <div class="footer">
            <p>‚ú® Real-time drift protection monitoring</p>
            <p>Pattern: OBSERVER √ó TRUTH √ó ATOMIC √ó ONE</p>
            <p>Auto-updates on user input and AI output</p>
        </div>
    </div>
    
    <script>
        let updateInterval;
        let fileWatcher;
        let lastUpdateTime = null;
        
        // Load dashboard data from AI context source of truth
        async function loadDashboardData() {
            try {
                const response = await fetch('.ai-context-source-of-truth.json?t=' + Date.now());
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                const data = await response.json();
                renderDashboard(data);
                lastUpdateTime = new Date(data._meta?.lastUpdated || Date.now());
                updateLastUpdated();
                return true;
            } catch (error) {
                showError(`Failed to load dashboard data: ${error.message}`);
                return false;
            }
        }
        
        function renderDashboard(data) {
            const container = document.getElementById('dashboard-content');
            const meta = data._meta || {};
            const systemStatus = data.systemStatus || {};
            const workspace = data.workspace || {};
            const projects = data.projects || {};
            
            let html = '<div class="grid">';
            
            // System Health Card
            html += `
                <div class="card">
                    <div class="card-header">üìä System Health</div>
                    <div class="metrics-grid">
                        <div class="metric">
                            <div class="metric-value">${systemStatus.overallHealth || 0}%</div>
                            <div class="metric-label">Overall Health</div>
                        </div>
                        <div class="metric">
                            <div class="metric-value" style="color: ${systemStatus.criticalIssues > 0 ? 'var(--accent-red)' : 'var(--accent-green)'}">${systemStatus.criticalIssues || 0}</div>
                            <div class="metric-label">Critical Issues</div>
                        </div>
                        <div class="metric">
                            <div class="metric-value" style="color: var(--accent-yellow)">${systemStatus.warnings || 0}</div>
                            <div class="metric-label">Warnings</div>
                        </div>
                    </div>
                    <div style="margin-top: 15px;">
                        <div class="score-bar">
                            <div class="score-fill ${getScoreClass(systemStatus.overallHealth)}" style="width: ${systemStatus.overallHealth || 0}%"></div>
                        </div>
                    </div>
                </div>
            `;
            
            // Current Project Card
            html += `
                <div class="card">
                    <div class="card-header">üì¶ Current Project</div>
                    <div class="project-card ${workspace.currentProject ? 'active' : 'unknown'}">
                        <div class="project-name">
                            ${workspace.currentProject || 'Workspace Root'}
                            <span class="project-status ${workspace.currentProject ? 'active' : 'unknown'}">${workspace.currentProject ? 'ACTIVE' : 'ROOT'}</span>
                        </div>
                        <div class="project-info">
                            Directory: <code>${workspace.currentDirectory || workspace.root || 'N/A'}</code>
                        </div>
                    </div>
                </div>
            `;
            
            // Active Projects Card
            if (projects.active && projects.active.length > 0) {
                html += `
                    <div class="card">
                        <div class="card-header">‚ú® Active Projects</div>
                `;
                projects.active.forEach(project => {
                    const statusClass = getProjectStatusClass(project.operationalStatus?.status);
                    const score = project.operationalStatus?.score || 0;
                    html += `
                        <div class="project-card ${statusClass}">
                            <div class="project-name">
                                ${project.name}
                                <span class="project-status ${statusClass}">${project.operationalStatus?.status || project.status || 'UNKNOWN'}</span>
                            </div>
                            <div class="project-info">
                                Directory: <code>${project.directory}</code><br>
                                Score: ${score}%
                            </div>
                            <div class="score-bar">
                                <div class="score-fill ${getScoreClass(score)}" style="width: ${score}%"></div>
                            </div>
                            ${project.operationalStatus?.criticalIssues?.length > 0 ? `
                                <div style="margin-top: 8px; font-size: 11px; color: var(--accent-red);">
                                    ‚ö†Ô∏è ${project.operationalStatus.criticalIssues.length} critical issue(s)
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            // Critical Actions Card
            if (systemStatus.criticalActions && systemStatus.criticalActions.length > 0) {
                html += `
                    <div class="card">
                        <div class="card-header">üö® Critical Actions</div>
                        <div class="critical-actions">
                `;
                systemStatus.criticalActions.forEach(action => {
                    html += `
                        <div class="action-item">
                            <div class="action-priority">${action.priority}</div>
                            <div class="action-text">${action.action}</div>
                            ${action.command ? `<div class="action-command">${action.command}</div>` : ''}
                            ${action.impact ? `<div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">Impact: ${action.impact}</div>` : ''}
                        </div>
                    `;
                });
                html += '</div></div>';
            }
            
            // Protection Layers Card
            html += `
                <div class="card">
                    <div class="card-header">üõ°Ô∏è Protection Layers</div>
                    <div class="protection-layers">
                        <div class="layer">
                            <span class="layer-name">Always-On Guardian</span>
                            <span class="layer-status">‚úÖ ACTIVE</span>
                        </div>
                        <div class="layer">
                            <span class="layer-name">Pre-Work Validation</span>
                            <span class="layer-status">‚úÖ ACTIVE</span>
                        </div>
                        <div class="layer">
                            <span class="layer-name">Pre-Commit Hooks</span>
                            <span class="layer-status">‚úÖ ACTIVE</span>
                        </div>
                        <div class="layer">
                            <span class="layer-name">Pre-Push Hooks</span>
                            <span class="layer-status">‚úÖ ACTIVE</span>
                        </div>
                        <div class="layer">
                            <span class="layer-name">CI/CD Validation</span>
                            <span class="layer-status">‚úÖ ACTIVE</span>
                        </div>
                    </div>
                </div>
            `;
            
            // Operational Metrics Card
            if (systemStatus.operationalMetrics) {
                const metrics = systemStatus.operationalMetrics;
                html += `
                    <div class="card">
                        <div class="card-header">üìà Operational Metrics</div>
                        <div class="metrics-grid">
                            <div class="metric">
                                <div class="metric-value">${metrics.fullyOperational || '0%'}</div>
                                <div class="metric-label">Fully Operational</div>
                            </div>
                            <div class="metric">
                                <div class="metric-value">${metrics.convergence?.toFixed(1) || 0}%</div>
                                <div class="metric-label">Convergence</div>
                            </div>
                            <div class="metric">
                                <div class="metric-value">${metrics.aeyonCompliance || 0}%</div>
                                <div class="metric-label">AEYON Compliance</div>
                            </div>
                            <div class="metric">
                                <div class="metric-value">${metrics.guardianSwarmActivation || 0}%</div>
                                <div class="metric-label">Guardian Swarm</div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        function getProjectStatusClass(status) {
            if (!status) return 'unknown';
            const normalized = status.toLowerCase().replace(/_/g, '-');
            if (normalized.includes('operational')) return 'operational';
            if (normalized.includes('needs-fixes') || normalized.includes('partial')) return 'needs-fixes';
            if (normalized.includes('not-running')) return 'not-running';
            return 'unknown';
        }
        
        function getScoreClass(score) {
            if (score >= 80) return 'high';
            if (score >= 50) return 'medium';
            return 'low';
        }
        
        function showError(message) {
            const container = document.getElementById('dashboard-content');
            container.innerHTML = `<div class="error">${message}</div>`;
        }
        
        function updateLastUpdated() {
            const element = document.getElementById('last-updated');
            if (lastUpdateTime) {
                const now = new Date();
                const diff = Math.floor((now - lastUpdateTime) / 1000);
                let timeStr;
                if (diff < 60) {
                    timeStr = `${diff}s ago`;
                } else if (diff < 3600) {
                    timeStr = `${Math.floor(diff / 60)}m ago`;
                } else {
                    timeStr = `${Math.floor(diff / 3600)}h ago`;
                }
                element.textContent = `Updated ${timeStr}`;
            }
        }
        
        function updateRefreshStatus(message) {
            document.getElementById('refresh-status').textContent = message;
        }
        
        // Watch for file changes using polling (works in all browsers)
        function startFileWatcher() {
            let lastModified = null;
            
            async function checkFile() {
                try {
                    const response = await fetch('.ai-context-source-of-truth.json?t=' + Date.now(), { method: 'HEAD' });
                    const currentModified = response.headers.get('last-modified');
                    
                    if (currentModified && currentModified !== lastModified) {
                        lastModified = currentModified;
                        updateRefreshStatus('üîÑ Updating...');
                        await loadDashboardData();
                        updateRefreshStatus('‚úÖ Auto-refreshing on changes...');
                    }
                } catch (error) {
                    // Silent fail - continue polling
                }
            }
            
            // Check every 2 seconds for file changes
            setInterval(checkFile, 2000);
        }
        
        // Initialize dashboard
        async function init() {
            updateRefreshStatus('üîÑ Loading...');
            const loaded = await loadDashboardData();
            
            if (loaded) {
                updateRefreshStatus('‚úÖ Auto-refreshing on changes...');
                
                // Poll every 5 seconds for updates
                updateInterval = setInterval(async () => {
                    await loadDashboardData();
                }, 5000);
                
                // Start file watcher
                startFileWatcher();
            } else {
                updateRefreshStatus('‚ùå Failed to load - retrying...');
                // Retry after 5 seconds
                setTimeout(init, 5000);
            }
        }
        
        // Start on page load
        init();
        
        // Update last updated time every second
        setInterval(updateLastUpdated, 1000);
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (updateInterval) {
                clearInterval(updateInterval);
            }
        });
    </script>
</body>
</html>

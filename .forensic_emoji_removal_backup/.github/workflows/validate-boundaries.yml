name: Validate Project Boundaries

on:
  workflow_dispatch:
  pull_request:
    branches: [ main, dev, master ]
    types: [opened, synchronize, reopened, closed]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  validate-boundaries:
    name: Validate Project Boundaries
    runs-on: ubuntu-latest  # Note: Validation workflow - doesn't need arc-runner-set
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Validate Project Boundaries
        run: |
          echo "üõ°Ô∏è  CI/CD BOUNDARY VALIDATION"
          echo "============================================================"
          node scripts/validate-project-boundaries.js
      
      - name: Context Boot Validation
        run: |
          echo "üõ°Ô∏è  CONTEXT BOOT VALIDATION"
          echo "============================================================"
          # Test from each active project directory
          for project in AiGuardian-Chrome-Ext-dev AIGuards-Backend EMERGENT_OS; do
            if [ -d "$project" ]; then
              echo "Validating $project..."
              cd "$project"
              node ../scripts/context-boot-validation.js || exit 1
              cd ..
            fi
          done
      
      - name: Check for Drift
        run: |
          echo "üîç DRIFT DETECTION"
          echo "============================================================"
          # Check if any files were modified in legacy directory
          if git diff --name-only HEAD~1 HEAD | grep -q "^AI-Guardians-chrome-ext/"; then
            echo "‚ö†Ô∏è  WARNING: Files modified in legacy directory"
            echo "   This may indicate drift. Review changes carefully."
            git diff --name-only HEAD~1 HEAD | grep "^AI-Guardians-chrome-ext/"
            # Don't fail, but warn
          else
            echo "‚úÖ No modifications detected in legacy directory"
          fi


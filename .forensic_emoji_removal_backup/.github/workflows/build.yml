name: Chrome Extension Build and Package
on:
  workflow_dispatch:
  pull_request:
    branches: [dev, main]
    types: [closed]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'

jobs:
  build:
    runs-on: [arc-runner-set]
    if: github.event_name == 'workflow_dispatch' || github.event.pull_request.merged == true

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: package-lock.json

    - name: Install dependencies
      run: npm ci

    - name: Run linting
      run: npm run lint || true

    - name: Build extension
      run: |
        npm run build || npm run build:prod || echo "No build script found, using source files"

    - name: Package extension
      run: |
        mkdir -p dist
        # Create zip package
        zip -r extension.zip . \
          -x "*.git*" \
          -x "*.github*" \
          -x "node_modules/*" \
          -x "*.md" \
          -x ".DS_Store" \
          -x "*.zip" || true
        
        # If zip command fails, use alternative method
        if [ ! -f extension.zip ]; then
          echo "Using alternative packaging method"
          cd dist || cd . && zip -r ../extension.zip . -x "*.git*" -x "*.github*" || true
        fi

    - name: Upload extension package
      uses: actions/upload-artifact@v4
      with:
        name: chrome-extension-package
        path: extension.zip
        retention-days: 7

    - name: Output build summary
      run: |
        BRANCH_NAME=${GITHUB_REF#refs/heads/}
        COMMIT_SHA=${GITHUB_SHA:0:8}
        TRIGGER_TYPE="${{ github.event_name }}"

        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ‰ Build Complete - AiGuardian-Chrome-Ext-orbital"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        echo "ğŸ“¦ Extension: AiGuardian-Chrome-Ext-orbital"
        echo "ğŸŒ¿ Branch: $BRANCH_NAME"
        echo "ğŸ“ Commit: $COMMIT_SHA"
        echo "âš¡ Trigger: $TRIGGER_TYPE"
        echo ""
        echo "âœ… Extension package created: extension.zip"
        echo ""

